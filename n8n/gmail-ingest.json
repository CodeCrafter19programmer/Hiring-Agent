{
  "name": "Gmail Ingest → AI Score → Sheets",
  "active": false,
  "nodes": [
    {
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "mode": "everyMinute",
              "seconds": 0
            }
          ]
        }
      },
      "id": "Cron",
      "name": "Cron (every min)",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "operation": "getAll",
        "returnAll": true,
        "additionalFields": {
          "q": "in:inbox is:unread has:attachment"
        }
      },
      "id": "GmailSearch",
      "name": "Gmail - Search Unread",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 1,
      "position": [420, 300],
      "credentials": {
        "gmailOAuth2": {
          "name": "<<GMAIL_CREDENTIAL_NAME>>"
        }
      }
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "SplitBatches",
      "name": "Split In Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 1,
      "position": [640, 300]
    },
    {
      "parameters": {
        "operation": "get",
        "messageId": "={{$json.id}}",
        "downloadAttachments": true
      },
      "id": "GmailGet",
      "name": "Gmail - Get w/Attachments",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 1,
      "position": [860, 300],
      "credentials": {
        "gmailOAuth2": {
          "name": "<<GMAIL_CREDENTIAL_NAME>>"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "// Select first CV-like attachment and extract basic headers\nconst headers = ($json.payload && $json.payload.headers) || [];\nconst getHeader = (name) => {\n  const h = headers.find(h => h.name === name);\n  return h ? h.value : '';\n};\nconst from = getHeader('From');\nconst subject = getHeader('Subject');\n// Parse sender name/email\nlet fromEmail = from;\nlet fullName = '';\nconst m = from.match(/\"?([^\"<]*)\"?\s*<([^>]+)>/);\nif (m) { fullName = (m[1] || '').trim(); fromEmail = (m[2] || '').trim(); }\n// Find first binary property that looks like a CV\nconst allowed = ['application/pdf','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document'];\nconst binKeys = Object.keys($binary || {});\nlet chosenKey = '';\nlet mimeType = '';\nfor (const k of binKeys) {\n  const mt = ($binary[k].mimeType || '').toLowerCase();\n  if (allowed.some(a => mt.includes(a))) { chosenKey = k; mimeType = mt; break; }\n}\nif (!chosenKey) {\n  return []; // Skip if no CV attachment found\n}\n// Move chosen binary to a consistent name\nconst out = {\n  fromEmail,\n  full_name: fullName || fromEmail.split('@')[0],\n  subject,\n  jobId: '', // will try to derive later\n  source_message_id: $json.id || $json.messageId || '',\n  source_thread_id: $json.threadId || '',\n};\n// Try to extract jobId from subject like JOB-123 or [JOB-123]\nconst jm = subject.match(/(JOB[-_ ]?\d+)/i);\nif (jm) out.jobId = jm[1].toUpperCase().replace(/\s+/g,'-');\nreturn [{ json: out, binary: { cv_file: $binary[chosenKey] } }];"
      },
      "id": "PickAttachment",
      "name": "Pick CV Attachment + Headers",
      "type": "n8n-nodes-base.function",
      "typeVersion": 2,
      "position": [1080, 300]
    },
    {
      "parameters": {
        "resource": "file",
        "operation": "upload",
        "binaryData": true,
        "binaryPropertyName": "cv_file",
        "parents": [
          "<<GOOGLE_DRIVE_FOLDER_ID>>"
        ],
        "options": {
          "fields": "id, webViewLink, webContentLink, mimeType, name"
        }
      },
      "id": "DriveUpload",
      "name": "Drive - Upload CV",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 2,
      "position": [1300, 220],
      "credentials": {
        "googleDriveOAuth2Api": {
          "name": "<<GOOGLE_DRIVE_CREDENTIAL_NAME>>"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "binary": [
            {
              "leftValue": "cv_file",
              "operation": "mimeType",
              "rightValue": "application/pdf"
            }
          ]
        }
      },
      "id": "IfPdf",
      "name": "IF PDF?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1300, 380]
    },
    {
      "parameters": {
        "operation": "extractText",
        "binaryPropertyName": "cv_file"
      },
      "id": "PdfExtract",
      "name": "PDF - Extract Text",
      "type": "n8n-nodes-base.pdf",
      "typeVersion": 1,
      "position": [1520, 340]
    },
    {
      "parameters": {
        "operation": "convert",
        "inputFormat": "docx",
        "outputFormat": "pdf",
        "binaryPropertyName": "cv_file"
      },
      "id": "CloudConvert",
      "name": "CloudConvert DOCX→PDF",
      "type": "n8n-nodes-base.cloudConvert",
      "typeVersion": 2,
      "position": [1520, 440],
      "credentials": {
        "cloudConvertApi": {
          "name": "<<CLOUDCONVERT_CREDENTIAL_NAME>>"
        }
      }
    },
    {
      "parameters": {
        "operation": "extractText",
        "binaryPropertyName": "data"
      },
      "id": "PdfExtractFromConverted",
      "name": "PDF - Extract (from converted)",
      "type": "n8n-nodes-base.pdf",
      "typeVersion": 1,
      "position": [1720, 440]
    },
    {
      "parameters": {
        "mode": "mergeByPosition"
      },
      "id": "MergeText",
      "name": "Merge Text",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2,
      "position": [1920, 380]
    },
    {
      "parameters": {
        "operation": "lookup",
        "documentId": "<<JOBS_SHEET_ID>>",
        "sheetName": "<<JOBS_SHEET_NAME>>",
        "lookupColumn": "job_id",
        "lookupValue": "={{$json.jobId}}",
        "returnAllMatches": false
      },
      "id": "SheetsLookupJob",
      "name": "Sheets - Lookup Job",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 3,
      "position": [2140, 300],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "name": "<<GOOGLE_SHEETS_CREDENTIAL_NAME>>"
        }
      }
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {"name": "full_name", "value": "={{$json.full_name}}"},
            {"name": "email", "value": "={{$json.fromEmail}}"},
            {"name": "phone", "value": ""},
            {"name": "cv_url", "value": "={{$node[\\\"Drive - Upload CV\\\"].json.webViewLink}}"},
            {"name": "cv_text", "value": "={{$node[\\\"Merge Text\\\"].json.text}}"},
            {"name": "job_id", "value": "={{$json.job_id || $node[\\\"Sheets - Lookup Job\\\"].json.job_id || $json.jobId}}"},
            {"name": "job_title", "value": "={{$json.title || $node[\\\"Sheets - Lookup Job\\\"].json.title || ''}}"},
            {"name": "job_requirements", "value": "={{$json.required_skills || $node[\\\"Sheets - Lookup Job\\\"].json.required_skills || ''}}"},
            {"name": "job_experience", "value": "={{$json.required_experience || $node[\\\"Sheets - Lookup Job\\\"].json.required_experience || ''}}"}
          ]
        }
      },
      "id": "SetPayload",
      "name": "Set Payload",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [2360, 300]
    },
    {
      "parameters": {
        "operation": "chat",
        "model": "gpt-3.5-turbo",
        "messages": [
          {"text": "You are an assistant that summarizes CVs. Output ONLY valid JSON with keys: summary (string), extracted_skills (array of strings), education (array of strings), experience_years (string).", "type": "system"},
          {"text": "Job Title: {{$json.job_title}}\nJob Requirements: {{$json.job_requirements}}\nCV Text: {{$json.cv_text}}\n\nRespond in JSON only.", "type": "user"}
        ],
        "temperature": 0
      },
      "id": "OpenAISummary",
      "name": "OpenAI - Summary",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 4,
      "position": [2580, 300],
      "credentials": {
        "openAiApi": {
          "name": "<<OPENAI_CREDENTIAL_NAME>>"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "const raw = $json.text || $json.response || $json.data || '';\nlet out;\ntry { out = JSON.parse(raw); } catch (e) { out = { summary: raw, extracted_skills: [], education: [], experience_years: '' }; }\nreturn [{ json: { ...$json, ...out } }];"
      },
      "id": "ParseSummary",
      "name": "Parse Summary JSON",
      "type": "n8n-nodes-base.function",
      "typeVersion": 2,
      "position": [2800, 300]
    },
    {
      "parameters": {
        "operation": "chat",
        "model": "gpt-3.5-turbo",
        "messages": [
          {"text": "You are an assistant that evaluates candidates against job requirements. Output ONLY valid JSON with keys: fit_score (0-100 number or string), missing_skills (array of strings), recommendation (string).", "type": "system"},
          {"text": "Job Title: {{$json.job_title}}\nJob Requirements: {{$json.job_requirements}}\nExtracted Skills: {{$json.extracted_skills}}\nSummary: {{$json.summary}}\n\nRespond in JSON only.", "type": "user"}
        ],
        "temperature": 0
      },
      "id": "OpenAIScore",
      "name": "OpenAI - Fit Score",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 4,
      "position": [3020, 300],
      "credentials": {
        "openAiApi": {
          "name": "<<OPENAI_CREDENTIAL_NAME>>"
        }
      }
    },
    {
      "parameters": {
        "functionCode": "const raw = $json.text || $json.response || $json.data || '';\nlet out;\ntry { out = JSON.parse(raw); } catch (e) { out = { fit_score: '', missing_skills: [], recommendation: '' }; }\nreturn [{ json: { ...$json, ...out } }];"
      },
      "id": "ParseScore",
      "name": "Parse Score JSON",
      "type": "n8n-nodes-base.function",
      "typeVersion": 2,
      "position": [3240, 300]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": "<<APPLICANTS_SHEET_ID>>",
        "sheetName": "<<APPLICANTS_SHEET_NAME>>",
        "keyRow": 1,
        "options": {
          "valueInputMode": "USER_ENTERED"
        },
        "columns": [
          "full_name",
          "email",
          "phone",
          "job_title",
          "job_id",
          "summary",
          "skills",
          "education",
          "experience",
          "fit_score",
          "missing_skills",
          "recommendation",
          "cv_url",
          "timestamp"
        ],
        "data": [
          [
            "={{$json.full_name}}",
            "={{$json.email}}",
            "={{$json.phone}}",
            "={{$json.job_title}}",
            "={{$json.job_id || $json.jobId}}",
            "={{$json.summary}}",
            "={{Array.isArray($json.extracted_skills) ? $json.extracted_skills.join(', ') : $json.extracted_skills}}",
            "={{Array.isArray($json.education) ? $json.education.join('; ') : $json.education}}",
            "={{$json.experience_years || $json.experience}}",
            "={{$json.fit_score}}",
            "={{Array.isArray($json.missing_skills) ? $json.missing_skills.join(', ') : $json.missing_skills}}",
            "={{$json.recommendation}}",
            "={{$json.cv_url || $node[\\\"Drive - Upload CV\\\"].json.webViewLink}}",
            "={{new Date().toISOString()}}"
          ]
        ]
      },
      "id": "SheetsAppend",
      "name": "Sheets - Append Applicant",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 3,
      "position": [3460, 300],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "name": "<<GOOGLE_SHEETS_CREDENTIAL_NAME>>"
        }
      }
    },
    {
      "parameters": {
        "operation": "modify",
        "messageId": "={{$node[\\\"Gmail - Get w/Attachments\\\"].json.id}}",
        "additionalFields": {
          "removeLabelIds": [
            "UNREAD"
          ]
        }
      },
      "id": "GmailMarkRead",
      "name": "Gmail - Mark Read",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 1,
      "position": [3680, 300],
      "credentials": {
        "gmailOAuth2": {
          "name": "<<GMAIL_CREDENTIAL_NAME>>"
        }
      }
    }
  ],
  "connections": {
    "Cron (every min)": {
      "main": [ [ { "node": "Gmail - Search Unread", "type": "main", "index": 0 } ] ]
    },
    "Gmail - Search Unread": {
      "main": [ [ { "node": "Split In Batches", "type": "main", "index": 0 } ] ]
    },
    "Split In Batches": {
      "main": [ [ { "node": "Gmail - Get w/Attachments", "type": "main", "index": 0 } ] ]
    },
    "Gmail - Get w/Attachments": {
      "main": [ [ { "node": "Pick CV Attachment + Headers", "type": "main", "index": 0 } ] ]
    },
    "Pick CV Attachment + Headers": {
      "main": [ [ { "node": "Drive - Upload CV", "type": "main", "index": 0 }, { "node": "IF PDF?", "type": "main", "index": 0 } ] ]
    },
    "IF PDF?": {
      "main": [ [ { "node": "PDF - Extract Text", "type": "main", "index": 0 } ], [ { "node": "CloudConvert DOCX→PDF", "type": "main", "index": 0 } ] ]
    },
    "CloudConvert DOCX→PDF": {
      "main": [ [ { "node": "PDF - Extract (from converted)", "type": "main", "index": 0 } ] ]
    },
    "PDF - Extract Text": {
      "main": [ [ { "node": "Merge Text", "type": "main", "index": 0 } ] ]
    },
    "PDF - Extract (from converted)": {
      "main": [ [ { "node": "Merge Text", "type": "main", "index": 1 } ] ]
    },
    "Merge Text": {
      "main": [ [ { "node": "Sheets - Lookup Job", "type": "main", "index": 0 } ] ]
    },
    "Sheets - Lookup Job": {
      "main": [ [ { "node": "Set Payload", "type": "main", "index": 0 } ] ]
    },
    "Set Payload": {
      "main": [ [ { "node": "OpenAI - Summary", "type": "main", "index": 0 } ] ]
    },
    "OpenAI - Summary": {
      "main": [ [ { "node": "Parse Summary JSON", "type": "main", "index": 0 } ] ]
    },
    "Parse Summary JSON": {
      "main": [ [ { "node": "OpenAI - Fit Score", "type": "main", "index": 0 } ] ]
    },
    "OpenAI - Fit Score": {
      "main": [ [ { "node": "Parse Score JSON", "type": "main", "index": 0 } ] ]
    },
    "Parse Score JSON": {
      "main": [ [ { "node": "Sheets - Append Applicant", "type": "main", "index": 0 } ] ]
    },
    "Sheets - Append Applicant": {
      "main": [ [ { "node": "Gmail - Mark Read", "type": "main", "index": 0 } ] ]
    }
  },
  "meta": {
    "templateCreds": {
      "gmailOAuth2": "<<GMAIL_CREDENTIAL_NAME>>",
      "googleDriveOAuth2Api": "<<GOOGLE_DRIVE_CREDENTIAL_NAME>>",
      "googleSheetsOAuth2Api": "<<GOOGLE_SHEETS_CREDENTIAL_NAME>>",
      "openAiApi": "<<OPENAI_CREDENTIAL_NAME>>",
      "cloudConvertApi": "<<CLOUDCONVERT_CREDENTIAL_NAME>>"
    }
  }
}
